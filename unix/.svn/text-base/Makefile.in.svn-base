# If this file has the name "Makefile.in" then it is a template for a
# Makefile;  to generate the actual Makefile, run "./configure", which
# is a configuration script generated by the "autoconf" program.

SHELL = /bin/sh

LIBOBJS = column.o custom.o derived.o fileio.o field.o format.o \
          handler.o persist.o remap.o std.o store.o string.o table.o \
	  univ.o view.o viewx.o

SHLOBJS = column.lo custom.lo derived.lo fileio.lo field.lo format.lo \
          handler.lo persist.lo remap.lo std.lo store.lo string.lo table.lo \
	  univ.lo view.lo viewx.lo

PYOBJS  = PyProperty.o PyRowRef.o PyStorage.o PyView.o PWOImp.o

SPYOBJS = PyProperty.lo PyRowRef.lo PyStorage.lo PyView.lo PWOImp.lo

TSTOBJS = regress.o tbasics.o tcusto1.o tcusto2.o tdiffer.o textend.o \
	  tformat.o tlimits.o tnotify.o tresize.o tstore1.o tstore2.o \
	  tstore3.o tstore4.o

DEMOS   = demo dump myio

#---------- Autoconf settings, can be overriden as "make" args

prefix = @prefix@
exec_prefix = @exec_prefix@
includedir = @includedir@
libdir = @libdir@
srcdir = @srcdir@
top_builddir = .

# not normally compiled with -g, but you can specify it in the make command
CXXFLAGS = -O3 -fomit-frame-pointer
#CXXFLAGS = -fguiding-decls -Wall -pedantic -Wno-unused -g

CXX = @CXX@
INSTALL = @LIBTOOL@ @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
LIBTOOL = @LIBTOOL@
VERSION = @VERSION@
TCL_BIN_DIR = @TCL_BIN_DIR@

#---------- Do not change, shorthand only

CXX_SWITCHES      = $(CXXFLAGS) -I$(srcdir)/../include \
				-I$(srcdir)/../src -I.
CXX_SWITCHES_TCL  = $(CXXFLAGS) -I$(srcdir)/../include \
				-I$(srcdir)/../../include \
				-I$(TCL_BIN_DIR)/../generic \
				-DUSE_TCL_STUBS
CXX_SWITCHES_PY   = $(CXXFLAGS) -I$(srcdir)/../include \
				-I$(srcdir)/../python/scxx \
				-I$(includedir)/python2.0 \
				-I/usr/include/python2.0 \
				-I$(includedir)/python1.5 \
				-I/usr/include/python1.5
CXX_SWITCHES_TEST = -I$(srcdir)/../include

#---------- The targets normally specified when calling "make"

all: @MK_TARGETS@

core: Makefile libmk4.a libmk4.la $(DEMOS)

tcl: Makefile libmk4tcl.a libmk4tcl.la Mk4tcl.so

python: Makefile libmk4py.a libmk4py.la Mk4py.so

test: Makefile libmk4.a regress
	if [ ! -d tests ]; then mkdir tests; fi
	./regress
	diff $(srcdir)/../tests/ok tests

test-tcl: tcl
	cd $(srcdir)/../tcl/test && tclsh8.3 all.tcl

install: @MK_INSTALL@

install-mk: libmk4.a libmk4.la
	$(INSTALL_DATA) -D $(srcdir)/../include/mk4.h \
					$(DESTDIR)/$(includedir)/mk4.h
	$(INSTALL_DATA) -D $(srcdir)/../include/mk4.inl \
					$(DESTDIR)/$(includedir)/mk4.inl
	$(INSTALL_DATA) -D $(srcdir)/../include/mk4str.h \
					$(DESTDIR)/$(includedir)/mk4str.h
	$(INSTALL_DATA) -D $(srcdir)/../include/mk4str.inl \
					$(DESTDIR)/$(includedir)/mk4str.inl
	$(INSTALL_DATA) -Ds libmk4.a $(DESTDIR)/$(libdir)/libmk4.a
	$(INSTALL_PROGRAM) -Ds libmk4.la $(DESTDIR)/$(libdir)/libmk4.la

install-tcl: libmk4tcl.a libmk4tcl.la
	$(INSTALL_DATA) -Ds libmk4tcl.a $(DESTDIR)/$(libdir)/libmk4tcl.a
	$(INSTALL_PROGRAM) -D libmk4tcl.la $(DESTDIR)/$(libdir)/libmk4tcl.la

install-python: libmk4py.a libmk4py.la
	$(INSTALL_DATA) -Ds libmk4py.a $(DESTDIR)/$(libdir)/libmk4py.a
	$(INSTALL_PROGRAM) -D libmk4py.la $(DESTDIR)/$(libdir)/libmk4py.la

clean:
	rm -f *.a *.la *.o *.lo *.so
	rm -f core $(DEMOS) struct regress myfile.dat secret.dat
	rm -rf tests/[a-z]* .libs

distclean: clean
	rm -f Makefile config.h config.status config.log config.cache libtool

dist: dist-tar

#---------- This defines what each of the targets does

Makefile: $(srcdir)/Makefile.in config.status
	$(SHELL) ./config.status

config.status: $(srcdir)/configure
	$(SHELL) ./config.status --recheck

$(srcdir)/configure: $(srcdir)/configure.in
	cd $(srcdir) && autoconf

dist-tar:
	rm -rf metakit-$(VERSION)
	mkdir metakit-$(VERSION)
	cp -pr $(srcdir)/../[^b]* metakit-$(VERSION) # omit "builds"
	rm -f `find mk_src-$(VERSION) -type f -name '_*'`
	rm -rf `find metakit-$(VERSION) -type d -name CVS`
	mkdir -p metakit-$(VERSION)/builds/tests
	cp $(srcdir)/reversed metakit-$(VERSION)/builds
	echo "placeholder" >metakit-$(VERSION)/builds/tests/!keepme.txt
	tar cfz metakit-$(VERSION).tar.gz metakit-$(VERSION)
	rm -rf metakit-$(VERSION)

libmk4.a: $(LIBOBJS)
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) $(LIBOBJS)

libmk4.la: $(LIBOBJS)
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) -export-dynamic \
		-rpath $(libdir) $(SHLOBJS)

libmk4tcl.a: mk4tcl.o mk4too.o libmk4.a
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) \
		mk4tcl.o mk4too.o $(LIBOBJS)

libmk4tcl.la: mk4tcl.o mk4too.o libmk4.a
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) -export-dynamic \
		-rpath $(libdir) mk4tcl.lo mk4too.lo $(SHLOBJS) \
		-L$(libdir) -ltclstub8.3

Mk4tcl.so: mk4tcl.o mk4too.o libmk4.a
	$(CXX) -o $@ $(CXX_SWITCHES) -shared mk4tcl.lo mk4too.lo $(SHLOBJS) \
		-L$(libdir) -ltclstub8.3

libmk4py.a: $(PYOBJS) libmk4.a
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) $(PYOBJS) $(LIBOBJS)

libmk4py.la: $(PYOBJS) libmk4.a
	$(LIBTOOL) --mode=link $(CXX) -o $@ $(CXX_SWITCHES) -export-dynamic \
		-rpath $(libdir) $(SPYOBJS) $(SHLOBJS)

Mk4py.so: $(PYOBJS) libmk4.a
	$(CXX) -o $@ $(CXX_SWITCHES) -shared $(SPYOBJS) $(SHLOBJS)

demo: $(srcdir)/../demos/demo.cpp libmk4.a
	$(LIBTOOL) --mode=link $(CXX) $(CXX_SWITCHES) -o $@ \
		$(srcdir)/../demos/demo.cpp libmk4.a

dump: $(srcdir)/../demos/dump.cpp libmk4.la
	$(LIBTOOL) --mode=link $(CXX) $(CXX_SWITCHES) -static -o $@ \
		$(srcdir)/../demos/dump.cpp libmk4.a

myio: $(srcdir)/../demos/myio.cpp libmk4.la
	$(LIBTOOL) --mode=link $(CXX) $(CXX_SWITCHES) -o $@ \
		$(srcdir)/../demos/myio.cpp libmk4.la

struct: $(srcdir)/../demos/struct.cpp
	$(LIBTOOL) --mode=link $(CXX) $(CXX_SWITCHES) -o $@ \
		$(srcdir)/../demos/struct.cpp -lmk4

regress: $(TSTOBJS) libmk4.a
	$(LIBTOOL) --mode=link $(CXX) -static -o $@ $(TSTOBJS) libmk4.a

#---------- Dependencies

mk4tcl.o: $(srcdir)/../tcl/mk4tcl.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_TCL) $?
mk4too.o: $(srcdir)/../tcl/mk4too.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_TCL) $?

PyProperty.o: $(srcdir)/../python/PyProperty.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_PY) $?
PyRowRef.o: $(srcdir)/../python/PyRowRef.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_PY) $?
PyStorage.o: $(srcdir)/../python/PyStorage.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_PY) $?
PyView.o: $(srcdir)/../python/PyView.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_PY) $?
PWOImp.o: $(srcdir)/../python/scxx/PWOImp.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES_PY) $?

column.o: $(srcdir)/../src/column.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
custom.o: $(srcdir)/../src/custom.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
derived.o: $(srcdir)/../src/derived.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
field.o: $(srcdir)/../src/field.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
fileio.o: $(srcdir)/../src/fileio.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
format.o: $(srcdir)/../src/format.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
handler.o: $(srcdir)/../src/handler.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
persist.o: $(srcdir)/../src/persist.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
remap.o: $(srcdir)/../src/remap.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
std.o: $(srcdir)/../src/std.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
store.o: $(srcdir)/../src/store.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
string.o: $(srcdir)/../src/string.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
table.o: $(srcdir)/../src/table.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
univ.o: $(srcdir)/../src/univ.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
view.o: $(srcdir)/../src/view.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?
viewx.o: $(srcdir)/../src/viewx.cpp
	$(LIBTOOL) --mode=compile $(CXX) -c $(CXX_SWITCHES) $?

regress.o: $(srcdir)/../tests/regress.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tbasics.o: $(srcdir)/../tests/tbasics.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tcusto1.o: $(srcdir)/../tests/tcusto1.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tcusto2.o: $(srcdir)/../tests/tcusto2.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tdiffer.o: $(srcdir)/../tests/tdiffer.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
textend.o: $(srcdir)/../tests/textend.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tformat.o: $(srcdir)/../tests/tformat.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tlimits.o: $(srcdir)/../tests/tlimits.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tnotify.o: $(srcdir)/../tests/tnotify.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tresize.o: $(srcdir)/../tests/tresize.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tstore1.o: $(srcdir)/../tests/tstore1.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tstore2.o: $(srcdir)/../tests/tstore2.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tstore3.o: $(srcdir)/../tests/tstore3.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@
tstore4.o: $(srcdir)/../tests/tstore4.cpp
	$(CXX) -c $(CXX_SWITCHES_TEST) $? -o $@

#---------- End
